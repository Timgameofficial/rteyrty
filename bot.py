import os
import re
import requests
from flask import Flask, request

TOKEN = os.getenv("API_TOKEN")
WEBHOOK_URL = f"https://rteyrty-haic.onrender.com/webhook/{TOKEN}"

# Паттерны для поиска спама: отдельно для ссылок и ключевых слов
SPAM_LINK_PATTERNS = [
    r"@\w+",                 # упоминание пользователя
    r"http[s]?://|www\.\w+", # любая ссылка
    r"t\.me/",               # ссылка на Telegram
]

SPAM_KEYWORDS = (
    # Русские слова
    "спам", "реклама", "накрутка", "подписчики", "лайки", "фолловеры", "продвижение",
    "казино", "рулетка", "слоты", "автоматы", "ставки", "букмекер", "беттинг", "bet",
    "криптовалюта", "крипта", "обмен", "bitcoin", "биткоин", "эфириум", "usdt", "кошелек",
    "майнинг", "инвестиции", "пирамида", "хайп", "скам", "мошенничество", "развод", "фрод",
    "фишинг", "вирус", "троян", "майнер", "взлом", "хак", "хакер", "брут", "эксплойт",
    "фейк", "поддельный", "паспорт", "права", "документы", "диплом", "сертификат",
    "оружие", "пистолет", "автомат", "нож", "граната", "бомба", "терроризм", "теракт",
    "киллер", "убийство", "наркотики", "наркотик", "наркота", "марихуана", "трава", "гашиш",
    "героин", "кокаин", "экстази", "амфетамин", "лсд", "спайс", "соли", "кодеин", "метамфетамин",
    "суицид", "самоубийство", "насилие", "изнасилование", "педофил", "педофилия",
    "порнография", "порно", "секс", "секс-услуги", "интим", "эскорт", "проституция",
    "шлюха", "проститутка", "бордель", "вебкам", "эротика", "хентай", "лоли", "инцест",
    "купить", "покупка", "продать", "продажа", "обмен", "обнал", "вывод", "доставка",
    "опт", "оптом", "скупка", "реализация", "аренда", "сдать", "арендовать",
    "поставки", "поставщик", "перепродажа", "бартер", "менять", "торговля", "торговать",
    "в наличии", "наличие", "в продаже", "выкуп", "закупка", "прайс", "каталог", "ассортимент",
    "интернет-магазин", "онлайн-магазин", "витрина", "лот", "ставка", "лотерея",
    "за дешево", "дёшево", "дёшевле", "скидка", "акция", "по акции", "распродажа", "бесплатно", "азарт",
    "игровые автоматы", "фрибет", "фри-спины", "ставки live", "линия", "коэффициент", "выигрыш", "проигрыш",
    "пополнение", "депозит", "депозит бонус", "бонус", "промокод", "регистрируйся", "регистрация",
    "забрать джекпот", "джекпот", "платформа ставок", "беттер", "лига ставок", "ставки на спорт",
    "военный контракт", "военное финансирование", "военные поставки", "черный рынок оружия", "военная разведка",
    # Украинские слова
    "спам", "реклама", "накрутка", "передплатники", "лайки", "фоловери", "просування",
    "казино", "рулетка", "слоти", "автомати", "ставки", "букмекер", "беттінг", "bet",
    "криптовалюта", "крипта", "обмін", "bitcoin", "біткоїн", "ефіріум", "usdt", "гаманець",
    "майнінг", "інвестиції", "піраміда", "хайп", "скам", "шахрайство", "розлучення", "фрод",
    "фішинг", "вірус", "троян", "майнер", "злом", "хак", "хакер", "брут", "експлойт",
    "фейк", "підроблений", "паспорт", "права", "документи", "диплом", "сертифікат",
    "зброя", "пістолет", "автомат", "ніж", "граната", "бомба", "тероризм", "теракт",
    "кілер", "вбивство", "наркотики", "наркотик", "наркота", "марихуана", "трава", "гашиш",
    "героїн", "кокаїн", "екстазі", "амфетамін", "лсд", "спайс", "солі", "кодеїн", "метамфетамін",
    "суїцид", "самогубство", "насильство", "згвалтування", "педофіл", "педофілія",
    "порнографія", "порно", "секс", "секс-послуги", "інтим", "ескорт", "проституція",
    "повія", "бордель", "вебкам", "еротика", "хентай", "лолі", "інцест",
    "купити", "купівля", "продати", "продаж", "обмін", "обнал", "виведення", "доставка",
    "опт", "оптом", "скупка", "реалізація", "оренда", "здати", "орендувати",
    "постачання", "постачальник", "перепродаж", "бартер", "міняти", "торгівля", "торгувати",
    "в наявності", "наявність", "у продажу", "викуп", "закупівля", "прайс", "каталог", "асортимент",
    "інтернет-магазин", "онлайн-магазин", "вітрина", "лот", "ставка", "лотерея",
    "за дешево", "дешево", "дешевше", "знижка", "акція", "по акції", "розпродаж", "безкоштовно", "азарт",
    "ігрові автомати", "фрибет", "фрі-спіни", "ставки live", "лінія", "коефіцієнт", "виграш", "програш",
    "поповнення", "депозит", "депозит бонус", "бонус", "промокод", "реєструйся", "реєстрація",
    "забрати джекпот", "джекпот", "платформа ставок", "беттер", "ліга ставок", "ставки на спорт",
    "військовий контракт", "військове фінансування", "військові постачання", "чорний ринок зброї", "військова розвідка"
)

def find_spam_reason(text):
    text = (text or "").lower()
    for pattern in SPAM_LINK_PATTERNS:
        if re.search(pattern, text):
            return "посилання або згадка"
    for keyword in SPAM_KEYWORDS:
        if keyword in text:
            return "ключове слово: продаж/купівля"
    return None

def delete_message(chat_id, message_id):
    url = f"https://api.telegram.org/bot{TOKEN}/deleteMessage"
    payload = {'chat_id': chat_id, 'message_id': message_id}
    try:
        resp = requests.post(url, data=payload)
        return resp.ok
    except Exception as e:
        print("Delete error:", e)
        return False

def send_warn(chat_id, user, reason):
    msg = f"Повідомлення від {user} було видалено. Причина: {reason}"
    url = f"https://api.telegram.org/bot{TOKEN}/sendMessage"
    payload = {'chat_id': chat_id, 'text': msg}
    try:
        requests.post(url, data=payload)
    except Exception as e:
        print("Send warn error:", e)

app = Flask(__name__)

@app.route(f"/webhook/{TOKEN}", methods=["POST"])
def webhook():
    try:
        update = request.get_json(force=True)
        if 'message' in update:
            msg = update['message']
            chat_id = msg['chat']['id']
            msg_id = msg['message_id']
            user = msg.get('from', {})
            # Формируем упоминание
            mention = f"@{user['username']}" if 'username' in user else user.get('first_name', 'Користувач')
            text = msg.get('text') or msg.get('caption') or ''
            reason = find_spam_reason(text)
            if reason:
                delete_message(chat_id, msg_id)
                send_warn(chat_id, mention, reason)
        return "ok", 200
    except Exception as e:
        print("Error:", e)
        return "ok", 200

@app.route('/', methods=['GET'])
def index():
    return "AntiSpam Bot працює", 200

if __name__ == "__main__":
    port = int(os.getenv("PORT", 5000))
    app.run(host="0.0.0.0", port=port)
