import os
import re
import json
import requests
from flask import Flask, request

TOKEN = os.getenv("API_TOKEN")
WEBHOOK_URL = f"https://rteyrty-haic.onrender.com/webhook/{TOKEN}"

# Патерни для пошуку спаму: окремо для посилань і ключових слів
SPAM_LINK_PATTERNS = [
    r"@\w+",                 # згадка користувача
    r"http[s]?://|www\.\w+", # будь-яке посилання
    r"t\.me/",               # посилання на Telegram
]

SPAM_KEYWORDS = ("спам", "реклама", "накрутка", "подписчики", "лайки", "фолловеры", "продвижение",  
"казино", "рулетка", "слоты", "автоматы", "ставки", "букмекер", "беттинг", "bet",  
"криптовалюта", "крипта", "обмен", "bitcoin", "биткоин", "эфириум", "usdt", "кошелек",  
"майнинг", "инвестиции", "пирамида", "хайп", "скам", "мошенничество", "развод", "фрод",  
"фишинг", "вирус", "троян", "майнер", "взлом", "хак", "хакер", "брут", "эксплойт",  
"фейк", "поддельный", "паспорт", "права", "документы", "диплом", "сертификат",  
"оружие", "пистолет", "автомат", "нож", "граната", "бомба", "терроризм", "теракт",  
"киллер", "убийство", "наркотики", "наркотик", "наркота", "марихуана", "трава", "гашиш",  
"героин", "кокаин", "экстази", "амфетамин", "ЛСД", "спайс", "соли", "кодеин", "метамфетамин",  
"суицид", "самоубийство", "насилие", "изнасилование", "педофил", "педофилия",  
"порнография", "порно", "секс", "секс-услуги", "интим", "эскорт", "проституция",  
"шлюха", "проститутка", "бордель", "вебкам", "эротика", "хентай", "лоли", "инцест", "купить", "покупка", "продать", "продажа", "обмен", "обменять", "заказать", "заказ",  
"доставка", "опт", "оптом", "скупка", "реализация", "аренда", "сдать", "арендовать",  
"поставки", "поставщик", "перепродажа", "бартер", "менять", "торговля", "торговать",  
"в наличии", "наличие", "в продаже", "выкуп", "закупка", "прайс", "каталог", "ассортимент",  
"интернет-магазин", "онлайн-магазин", "витрина", "лот", "ставка", "лотерея",  
"за дешево", "дёшево", "дёшевле", "скидка", "акция", "по акции", "распродажа", "бесплатно", "азарт",
"казино", "ставки", "букмекер", "букмекерская контора", "беттинг", "ставки на спорт", "онлайн-казино", "слоты", "рулетка", "покер", "блэкджек",
"игровые автоматы", "фрибет", "фри-спины", "ставка", "ставки live", "линия", "коэффициент", "выигрыш", "проигрыш", "пополнить счёт", "вывести выигрыш",
"депозит", "депозит бонус", "бонус", "промокод", "регистрируйся", "регистрация", "забрать джекпот", "джекпот", "платформа для ставок", "сервис ставок", "казино онлайн", "играть на деньги", "игра на деньги", "игровая комната", "играть в рулетку", "играть в слоты", "контора", "букмекерская", "минимальная ставка", "максимальная ставка", "ставки без риска", "пари", "правила ставок", "ставки по телефону", "бет", "ставь", "ставь сейчас", "ставки на киберспорт", "ставки на кибер", "букмекерский счёт", "вывод средств", "за депозит", "забрать бонус", "бездепозитный бонус", "оружие", "пистолет", "револьвер", "автомат", "винтовка", "карабин", "снайперская винтовка", "дробовик", "пулемёт", "пистолет-пулемёт", "стрелковое оружие", "боевое оружие", "огнестрельное", "холодное оружие", "нож", "клинок", "граната", "взрывчатка", "патроны", "боеприпасы", "магазин для патронов", "обойма", "прицел", "оружейный магазин", "купить оружие", "продать оружие", "продажа пистолета", "куплю пистолет", "продам винтовку", "заказать оружие", "доставка оружия", "перевозка оружия", "склад оружия", "поставщик оружия", "перепродажа оружия", "черный рынок оружия", "разрешение на оружие", "лицензия на оружие", "серийный номер", "запчасти для оружия", "тюнинг оружия", "массовая закупка оружия", "опт оружия", "оружейный лот", "оружие без документов", "продажа патронов", "куплю патроны", "снаряжение", "тактическое снаряжение", "бронежилет", "глушитель", "самодельное оружие", "война", "боевые действия", "конфликт", "военные операции", "обстрел", "артобстрел", "миномёт", "ракетный удар", "ракета", "ракеты", "бомбардировка", "эвакуация", "блокада", "оккупация", "войсковая часть", "батальон", "бригада", "наёмники", "наемники", "милитант", "боевик", "ополченец", "территориальная оборона", "военная техника", "танк", "бронетехника", "БМП", "броня", "пехота", "ударный беспилотник", "дрон-ударник", "доставка вооружения", "логистика войск", "боеприпасы", "снабжение", "полевой госпиталь", "раненые", "потери", "гибель", "теракт", "диверсия", "подрыв", "захват", "освобождение", "контрнаступление", "переговоры о перемирии", "перемирие", "военное обучение", "военные услуги", "заказать наёмника", "найм бойцов", "призыв", "мобилизация",
"военный контракт", "военное финансирование", "военные поставки", "черный рынок оружия", "военная разведка", "подготовка боевых действий",
"спам", "реклама", "накрутка", "передплатники", "лайки", "фоловери", "просування",
"казино", "рулетка", "слоти", "автомати", "ставки", "букмекер", "беттінг", "bet",
"криптовалюта", "крипта", "обмін", "bitcoin", "біткоїн", "ефіріум", "usdt", "гаманець",
"майнінг", "інвестиції", "піраміда", "хайп", "скам", "шахрайство", "розлучення", "фрод",
"фішинг", "вірус", "троян", "майнер", "злом", "хак", "хакер", "брут", "експлойт",
"фейк", "підроблений", "паспорт", "права", "документи", "диплом", "сертифікат",
"зброя", "пістолет", "автомат", "ніж", "граната", "бомба", "тероризм", "теракт",
"кілер", "вбивство", "наркотики", "наркотик", "наркота", "марихуана", "трава", "гашиш",
"героїн", "кокаїн", "екстазі", "амфетамін", "ЛСД", "спайс", "солі", "кодеїн", "метамфетамін",
"суїцид", "самогубство", "насильство", "згвалтування", "педофіл", "педофілія",
"порнографія", "порно", "секс", "секс-послуги", "інтим", "ескорт", "проституція",
"повія", "повія", "бордель", "вебкам", "еротика", "хентай", "лолі", "інцест", "купити", "купівля", "продати", "продаж", "обмін", "обмінювати", "замовити", "замовлення",
"доставка", "опт", "оптом", "скупка", "реалізація", "оренда", "здати", "орендувати",
"постачання", "постачальник", "перепродаж", "бартер", "міняти", "торгівля", "торгувати",
"в наявності", "наявність", "у продажу", "викуп", "закупівля", "прайс", "каталог", "асортимент",
"інтернет-магазин", "онлайн-магазин", "вітрина", "лот", "ставка", "лотерея",
"за дешево", "дешево", "дешевше", "знижка", "акція", "по акції", "розпродаж", "безкоштовно", "азарт", "казино", "ставки", "букмекер", "букмекерська контора", "беттінг", "ставки на спорт", "онлайн" "покер", "блэкджек", "ігрові автомати", "фрібет", "фрі-спини", "ставка", "ставки live", "лінія", "коефіцієнт", "виграш", "програш", "поповнити рахунок", "вивести виграш", "депозит", "депозит бонус" "реєструйся", "реєстрація", "забрати джекпот", "джекпот", "платформа для ставок", "сервіс ставок", "казино онлайн", "грати на гроші", "гра на гроші", "ігрова кімната", "грати в рулетку", "грати в слоти", "контора", "букмеакерська", ризику", "парі", "правила ставок", "ставки по телефону", "бет", "ставь", "ставь зараз", "ставки на кіберспорт", "ставки на кібер", "букмекерський рахунок", "виведення коштів", "за депозит", "забрати бонус", "бездепозитний бонус", "зброю", "зброю" "гвинтівка", "карабін", "снайперська гвинтівка", "дробовик", "кулемет", "пістолет-кулемет", "стрілецька зброя", "бойова зброя", "вогнепальна", "холодна зброя", "ніж", "клинок", "граната", "вибухати патронів", "обойма", "приціл", "збройовий магазин", "купити зброю", "продати зброю", "продаж пістолета", "куплю пістолет", "продам гвинтівку", "замовити зброю", "доставка зброї", "перевезення зброї", "склад зброї", "склад зброї" зброї", "дозвіл на зброю", "ліцензія на зброю", "серійний номер", "запчастини для зброї", "тюнінг зброї", "масова закупівля зброї", "опт зброї", "збройовий лот", "зброя без документів", "продаж патронів", "купля патронів", "купля патронів", "купля патронів" "бронежилет", "глушник", "саморобна зброя", "війна", "бойові дії", "конфлікт", "військові операції", "обстріл", "артобстріл", "міномет", "ракетний удар", "ракета", "ракети", "бомбардування", "евакуація", " "батальйон", "бригада", "найманці", "найманці", "мілітант", "бойовик", "ополченець", "територіальна оборона", "військова техніка", "танк", "бронетехніка", "БМП", "броня", "піхота", "ударний безпілотник", "ударний безпілотник", " військ", "боєприпаси", "постачання", "польовий госпіталь", "поранені", "втрати", "загибель", "теракт", "диверсія", "підрив", "захоплення", "звільнення", "контрнаступ", "переговори про перемир'я", "перемир'я", "військове навчання" бійців", "заклик", "мобілізація", "військовий контракт", "військове фінансування", "військові поставки", "чорний ринок зброї", "військова розвідка", "підготовка бойових дій")
  # Просто змінюйте або додавайте слова тут

def find_spam_reason(text):
    text = text.lower()
    for pattern in SPAM_LINK_PATTERNS:
        if re.search(pattern, text):
            return "посилання або згадка"
    for keyword in SPAM_KEYWORDS:
        if keyword in text:
            return "ключове слово: продаж/купівля"
    return None

def delete_message(chat_id, message_id):
    url = f"https://api.telegram.org/bot{TOKEN}/deleteMessage"
    payload = {'chat_id': chat_id, 'message_id': message_id}
    try:
        resp = requests.post(url, data=payload)
        return resp.ok
    except Exception as e:
        print("Delete error:", e)
        return False

def send_warn(chat_id, user, reason):
    msg = f"Повідомлення від {user} було видалено. Причина: {reason}"
    url = f"https://api.telegram.org/bot{TOKEN}/sendMessage"
    payload = {'chat_id': chat_id, 'text': msg}
    try:
        requests.post(url, data=payload)
    except Exception as e:
        print("Send warn error:", e)

app = Flask(__name__)

@app.route(f"/webhook/{TOKEN}", methods=["POST"])
def webhook():
    try:
        update = request.get_json(force=True)
        if 'message' in update:
            msg = update['message']
            chat_id = msg['chat']['id']
            msg_id = msg['message_id']
            user = msg['from']
            # Формуємо згадку
            if "username" in user:
                mention = f"@{user['username']}"
            else:
                mention = user.get('first_name', 'Користувач')
            text = msg.get('text', '') or msg.get('caption', '')
            reason = find_spam_reason(text)
            if reason:
                delete_message(chat_id, msg_id)
                send_warn(chat_id, mention, reason)
        return "ok", 200
    except Exception as e:
        print("Error:", e)
        return "ok", 200

@app.route('/', methods=['GET'])
def index():
    return "AntiSpam Bot працює", 200

if __name__ == "__main__":
    port = int(os.getenv("PORT", 5000))
    app.run(host="0.0.0.0", port=port)
